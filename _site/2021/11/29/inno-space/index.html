<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MySQL InnoDB space file &#8211; baotiao</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdn.mathjax.org">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="MySQL InnoDB 物理文件管理">
    <meta name="robots" content="all">
    <meta name="author" content="baotiao">
    <meta name="keywords" content="">
    <link rel="canonical" href="http://localhost:4000/2021/11/29/inno-space/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for baotiao" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202204240501" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="MySQL InnoDB space file">
    <meta property="og:description" content="做有积累的事情">
    <meta property="og:url" content="http://localhost:4000/2021/11/29/inno-space/">
    <meta property="og:site_name" content="baotiao">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@baotiao" />
    
    <meta name="twitter:title" content="MySQL InnoDB space file" />
    <meta name="twitter:description" content="MySQL InnoDB 物理文件管理" />
    <meta name="twitter:url" content="http://localhost:4000/2021/11/29/inno-space/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://localhost:4000" class="site-title">baotiao</a>
      <nav class="site-nav">
        
    

    
        <a href="/about/">About</a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


    

    

    

    

    
        <a href="/links/">Links</a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


    

    

    

    

    

    
        <a href="/paper/">Paper</a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


      </nav>
      <div class="clearfix"></div>
      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>MySQL InnoDB space file</h1>
  <span class="post-meta">Nov 29 2021</span><br>
  
  <span class="post-meta small">
  
    6 minute read
  
  </span>
</div>

<article class="post-content">
  <p>InnoDB 最后的数据都会落到文件中.</p>

<p>整体而言InnoDB 里面除了redo log 以外都使用统一的结构进行管理, 包括system tablespace(ibdata1), user tablespace(用户表空间), undo log, temp tablespace. 这个结构我们统称space file.</p>

<p>接下来会4篇文章介绍InnoDB 主要的从文件, page, index, record 在具体文件里面是如何分布的, 这里大量引用了Jeremy Cole 里面的图片和文章的内容.</p>

<p>同时介绍的过程会结合inno_space 工具直观的打印出文件的内部结构.</p>

<p>什么是inno_space?</p>

<p><a href="./https://github.com/baotiao/inno_space">inno_space </a> 是一个可以直接访问InnoDB 内部文件的命令行工具,  可以打印出文件的内部结构.</p>

<p>Jeremy Cole 用ruby 写了一个类似的工具, 不过不支持MySQL 8.0, 并且ruby 编译以及改动起来特别麻烦, 所以用cpp 重写了一个. inno_space 做到不依赖任何外部文件, 只需要make, 就可以得到可执行文件, 做到开箱即用.</p>

<p>inno_space 除了支持打印出文件的具体结构之外, 同时还支持修复 corrupt page 功能, 如果遇到InnoDB 表文件中的page 损坏, 实例无法启动的情况, 如果损坏的只是leaf page, inno_space 可以将corrupt page 跳过, 从而保证实例能够启动, 并且将绝大部分的数据找回.</p>

<p>inno_space 还提供分析表文件中的数据情况, 是否有过多的free page, 从而给用户建议是否需要执行 optimize table 等等</p>

<p>具体可以看代码, 在github 上面开源: https://github.com/baotiao/inno_space/commits/main</p>

<ol>
  <li>InnoDB space file 也就是整个InnoDB 文件系统的管理, 介绍.ibd 文件的基础结构. <a href="./InnoDB space file.md">InnoDB space file</a></li>
  <li>
    <p>InnoDB page management  具体的在InnoDB file space 这些16kb 大小的page 是如何管理的 <a href="./InnoDB page management.md">Page management</a></p>
  </li>
  <li>
    <p>InnoDB Index page 上面讲了这16kb 的page 如何管理, 那么我们细看一下最常见的page 类型, Index Page 存的是用户表空间的数据,  这些Index Page 是如何维护成一个table 的数据 <a href="./InnoDB Index page.md">Index page</a></p>
  </li>
  <li>InnoDB record 是具体在InnoDB page 里面, Mysql 里面的record 是如何保存在InnoDB page 里面的 <a href="./InnoDB record.md">InnoDB record</a></li>
</ol>

<p>这篇文章只描述InnoDB file space, 接下来会有文章介绍InnoDB page management,  InnoDB page, InnoDB record</p>

<h4 id="1-innodb-space-file-基本结构">1. InnoDB space file 基本结构</h4>

<p><strong>Page</strong></p>

<p>在InnoDB 里面, 16kb 大小的page 是最小的原子单元</p>

<p>其他的大小都是在page 之上, 因此有:</p>

<p>1 page = 16kB = 16384 bytes</p>

<p>1 extent = 64 pages = 1 MB</p>

<p>FSP_HDR  page = 256 extents = 16384 pages = 256 MB</p>

<p>page 有最基础的38字节的 FIL Header, 8字节的FIL Trailer</p>

<p><img src="https://i.imgur.com/NxR6eb3.jpg" alt="Imgur" style="zoom: 50%;" /></p>

<p>主要的内容包括:</p>

<ol>
  <li>
    <p>Checksum: 这个page 的checksum, 用来判断page 是否有corrupt</p>
  </li>
  <li>
    <p>Page Number: Page Number 可以计算出在文件上的偏移量, 一个page 是否初始化了, 也可以看这个page number 是否设置对了, 这个值其实是冗余的, 根据file offset 可以算出来, 所以这个值是否正确, 就可以知道这个page 是否被初始化了</p>
  </li>
  <li>
    <p>Previous Page/Next Page: 这个只有在Index page 的时候才有用, 而且只有leaf page 的时候才有用, non-leaf page 是没用的, 大部分类型的page 并没有使用这个字段.</p>
  </li>
  <li>
    <p>LSN for last page modification: 刷脏的时候, 写入这个page 的 newest_modification_lsn</p>

    <p>​	mach_write_to_8(page + FIL_PAGE_LSN, newest_lsn);</p>
  </li>
  <li>
    <p>Page Type: 这个page 具体的类型, 比如是btree index leaf-page, undo log page,  btree index non-leaf page, insert buffer, fresh allocated page, 属于ibdata1 的system page 等等. Page Type 最重要, 决定这个page 的用途类型, 里面很多字段就不一样了</p>
  </li>
  <li>
    <p>Flush LSN:  保存的是已经flush 到磁盘的page 的最大lsn 信息. 只有在space 0 page 0 这个page 里面有用, 其他地方都没用.. 什么用途?什么时候写入? 什么时候读取?</p>

    <p>在进行shutdown 的时候, 或者执行force checkpoint的时候通过 fil_write_flushed_lsn_to_data_files 写入.</p>

    <p>用途是在启动的时候, 读取这个flush lsn, 可以确保这个lsn 之前的page 已经刷到磁盘了, 从这个flush lsn 之后的redo log 才是uncheckpoint redo log, 但是其实redo log 里面已经有了 checkpoint 的信息了, 为何还需要这个字段?</p>

    <p>logs_empty_and_mark_files_at_shutdown =&gt;</p>

    <p>在实例启动的时候, innobase_start_or_create_for_mysql =&gt; open_or_create_data_files =&gt; fil_read_first_page</p>

    <p>fil_read_first_page 里面会读取出这个lsn 信息, 用于更新启动的时候的 min_flushed_lsn, max_flushed_lsn. 因为这个时候redo log 模块还没有初始化,  可以拿这个两个Lsn 做一些简单的判断</p>

    <p>整体来看, 这个字段目前已经没啥用了, 但是每一个page 都占用了8字节的空间, 还是比较浪费, 可以充分复用</p>
  </li>
  <li>
    <p>Space ID: 当前Page 所属space ID (8.0 里面已经将该字段删除了)</p>
  </li>
</ol>

<p>通过inno_space 可以看到相应的结构:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./inno -f ~/git/primary/dbs2250/sbtest/sbtest1.ibd -p 10

==========================block==========================
FIL Header:
CheckSum: 2065869235
Page number: 10
Previous Page: 9
Next Page: 11
Page LSN: 554513658770
Page Type: 17855
Flush LSN: 0
</code></pre></div></div>

<p><strong>Space file</strong></p>

<p>一个space file 就是2^32 个page 的合集, 连续64个page 叫做extent, 256个连续的extent 会有一个XDES(extent descriptor) 进行管理, 第一个XDES 又叫做FSP_HDR, 还有一些额外的信息.</p>

<p>下图就是这个基本文件组织结构的描述, 无论是undo space, system space, 用户的table space 都是这样结构</p>

<p><img src="../../../Library/Application Support/typora-user-images/image-20211118052832966.png" alt="image-20211118052832966" style="zoom:40%;" /></p>

<p>所有的space file 前3个page 都是一样.</p>

<p>page 0 是 FSP_HDR(file space header)</p>

<p>page 1 是 insert buffer bitmap</p>

<p>page 2 是 inode page, 下一节会介绍</p>

<p><strong>The system space</strong></p>

<p>system space 的space id = 0, 文件名叫 ibdata1, 也就是系统文件.</p>

<p><img src="https://i.imgur.com/l3UHMqR.jpg" alt="Imgur" /></p>

<p>page 0, 1, 2 这3个page 所有的space file 都一样</p>

<p>在system space 里面接下来的3, 4, 5 等等page 也都是有指定的用途</p>

<p>page 3 存放的是insert buffer 相关信息</p>

<p>page 4 存放的是insert buffer tree 的root page</p>

<p>page 5 存放的是trx_sys 模块相关信息, 比如最新的trx id, binlog 信息等等.</p>

<p>page 6 存放的是FSP_FIRST_RSEG_PAGE_NO, 也就是undo log rollback segment的header page. 其他的undo log rollback segment 都在不同的undo log 文件中</p>

<p><img src="https://i.imgur.com/ScLs3Oj.jpg" alt="Imgur" style="zoom:40%;" /></p>

<p>page 7 存放的是 FSP_DICT_HDR_PAGE_NO, 存放的是DD 相关的信息</p>

<p>page 64-127 是first 64 个double write buffer 的位置</p>

<p>page 128-191 是second 64个double write buffer 的位置</p>

<p>剩下的其他page 就有可能被申请成Undo log page 等等了</p>

<p>通过inno_space 打开 ibdata1文件可以观察到如下的信息</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>File path /home/zongzhi.czz/git/primary/log2250/ibdata1 path
File size 209715200
start           end             count           type
0               0               1               FSP HDR
1               1               1               INSERT BUFFER BITMAP
2               2               1               INDEX NODE PAGE
3               3               1               SYSTEM PAGE
4               4               1               INDEX PAGE
5               5               1               TRX SYSTEM PAGE
6               7               2               SYSTEM PAGE
8               8               1               SDI INDEX PAGE
9               12799           12790           FRESHLY ALLOCATED PAGE
</code></pre></div></div>

<p>打开一个普通的用户表空间, 可以看到如下的结构.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└─[$] ./inno -f ~/git/primary/dbs2250/sbtest/sbtest1.ibd -c list-page-type
File path /home/zongzhi.czz/git/primary/dbs2250/sbtest/sbtest1.ibd path, page num 0
page num 0
==========================space page type==========================
File size 2604662784
start           end             count           type
0               0               1               FSP HDR
1               1               1               INSERT BUFFER BITMAP
2               2               1               INDEX NODE PAGE
3               3               1               SDI INDEX PAGE
4               16383           16380           INDEX PAGE
16384           16384           1               XDES
16385           16385           1               INSERT BUFFER BITMAP
16386           31990           15605           INDEX PAGE
31991           31999           9               FRESHLY ALLOCATED PAGE
32000           32767           768             INDEX PAGE
32768           32768           1               XDES
32769           32769           1               INSERT BUFFER BITMAP
32770           49151           16382           INDEX PAGE
49152           49152           1               XDES
49153           49153           1               INSERT BUFFER BITMAP
49154           65535           16382           INDEX PAGE
65536           65536           1               XDES
65537           65537           1               INSERT BUFFER BITMAP
65538           81919           16382           INDEX PAGE
81920           81920           1               XDES
</code></pre></div></div>

<p>下一篇物理页管理我们会更详细的介绍.</p>

<p><strong>File Per Table</strong></p>

<p>InnoDB 常见的file per table 模式下. 一个table 对应一个.ibd 文件.</p>

<p><img src="https://i.imgur.com/I2vFSGn.png" alt="Imgur" /></p>

<p>page 0, 1, 2 这3个page 所有的space file 都一样</p>

<p>page 3 一般是 primary index root page.</p>

<p>page 4 一般是 secondary index root page. 当然这里是create table 就指定的时候, 比如如下 page 4 一般是k_1 这个index 的root page</p>

<pre><code class="language-mysql">Create Table: CREATE TABLE `sbtest1` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `k` int(11) NOT NULL DEFAULT '0',
  `c` char(120) NOT NULL DEFAULT '',
  `pad` char(60) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  KEY `k_1` (`k`)
) ENGINE=InnoDB AUTO_INCREMENT=237723 DEFAULT CHARSET=latin1
1 row in set (0.00 sec)
</code></pre>

<p>如果后面运行过程中再加的新的 secondary index, 新的Index的root page 那就不会是连续着的, 而是分散在其他page 上了</p>

<p>alter table sbtest1 add index idx_c(c);</p>

<p>比如执行alter table 以后, 额外增加的一个index, 通过inno_space 工具可以看到每一个index 的root page 所在等等</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Example 2:
./inno -f ~/git/primary/dbs2250/sbtest/sbtest1.ibd -c index-summary
File path /home/zongzhi.czz/git/primary/dbs2250/sbtest/sbtest1.ibd path, page num 0
==========================Space Header==========================
Space ID: 15
Highest Page number: 158976
Free limit Page Number: 152256
FREE_FRAG page number: 24
Next Seg ID: 7
File size 2604662784
========Primary index========
Primary index root page space_id 15 page_no 4
Btree hight: 2
&lt;&lt;&lt;Leaf page segment&gt;&gt;&gt;
SEGMENT id 4, space id 15
Extents information:
FULL extent list size 2140
FREE extent list size 0
PARTIALLY FREE extent list size 1
Pages information:
Reserved page num: 137056
Used page num: 137003
Free page num: 53

&lt;&lt;&lt;Non-Leaf page segment&gt;&gt;&gt;
SEGMENT id 3, space id 15
Extents information:
FULL extent list size 1
FREE extent list size 0
PARTIALLY FREE extent list size 1
Pages information:
Reserved page num: 160
Used page num: 116
Free page num: 44

========Secondary index========
Secondary index root page space_id 15 page_no 31940
Btree hight: 2
&lt;&lt;&lt;Leaf page segment&gt;&gt;&gt;
SEGMENT id 6, space id 15
Extents information:
FULL extent list size 7
FREE extent list size 0
PARTIALLY FREE extent list size 219
Pages information:
Reserved page num: 14465
Used page num: 12160
Free page num: 2305

&lt;&lt;&lt;Non-Leaf page segment&gt;&gt;&gt;
SEGMENT id 5, space id 15
Extents information:
FULL extent list size 0
FREE extent list size 0
PARTIALLY FREE extent list size 0
Pages information:
Reserved page num: 19
Used page num: 19
Free page num: 0

**Suggestion**
File size 2604662784, reserved but not used space 39354368, percentage 1.51%
Optimize table will get new fie size 2565308416

</code></pre></div></div>

<ol>
  <li>这里tablespace id 是15</li>
  <li>Btree 的高度是3层</li>
  <li>secondary Index 由于只存索引, 所以primary index 占用的空间是secondary index 的10倍</li>
  <li>primary Index 上面大量的page 都是用满的状态, 而secondary 会20% 左右的空闲page</li>
  <li>整体而言, 空闲page 只占了文件的1.51% 左右, 所以不需要做optimize table 操作的</li>
</ol>


</article>






  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname  = 'baotiao';
    var disqus_identifier = '/2021/11/29/inno-space';
    var disqus_title      = 'MySQL InnoDB space file';

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>
    </div>
  </div>

  <footer class="center">
</footer>


</body>
</html>
